{% extends "mturk_manager/base.html" %}
{% load static %}

{% block name_project %}{{ name_project }}{% endblock %}

{% block body %}
<script src="{% static 'mturk_manager/js/jquery-3.1.1.min.js' %}"></script>
<script src="{% static 'mturk_manager/js/popper.js' %}"></script>
<script src="{% static 'mturk_manager/js/bootstrap.js' %}"></script>
<script src="{% static 'mturk_manager/js/main.js' %}"></script>

<script>
	let hit_wrapper;
	let question;
	let assignment_wrapper;
	let answer;
	let answer_raw;
	const list_messages_reject = [
	{% for message in queryset_messages_reject.all %}
		'{{ message.message }}',
	{% endfor %}
	]

	function create_inputs(id, state='submitted')
	{
		let result = `
			<div class="custom-control custom-checkbox d-inline">
				<input type="checkbox" class="custom-control-input" id="checkbox_assignment_PLACEHOLDER_ID" data-id_assignment="PLACEHOLDER_ID" name="checkbox_assignment" value="PLACEHOLDER_ID" PLACEHOLDER_DISABLED>
				<label class="custom-control-label" for="checkbox_assignment_PLACEHOLDER_ID"></label>
			</div>
			<button type="button" name="task" value="button_mturk_approve__PLACEHOLDER_ID" data-id_assignment="PLACEHOLDER_ID" class="btn btn-sm PLACEHOLDER_SUCCESS approve_assignment" PLACEHOLDER_DISABLED>Approve</button>
			<div class="btn-group btn-group-sm">
            	<button type="button" name="task" value="button_mturk_reject__PLACEHOLDER_ID" data-id_assignment="PLACEHOLDER_ID" class="btn PLACEHOLDER_DANGER reject_assignment" PLACEHOLDER_DISABLED>Reject</button>
            	<button type="button" class="btn PLACEHOLDER_DANGER dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" PLACEHOLDER_DISABLED></button>
					<div class="dropdown-menu dropdown_reject_assignment">
						PLACEHOLDER_MESSAGES_REJECT
					</div>
            </div>
		`.replace(/PLACEHOLDER_ID/g, id)

		if(state != 'submitted') 
		{
			result = result.replace(/PLACEHOLDER_DISABLED/g, 'disabled')
			if(state == 'approved')
			{
				result = result
				.replace(/PLACEHOLDER_SUCCESS/g, 'btn-success')
				.replace(/PLACEHOLDER_DANGER/g, 'btn-light')
			} else {
				result = result
				.replace(/PLACEHOLDER_SUCCESS/g, 'btn-light')
				.replace(/PLACEHOLDER_DANGER/g, 'btn-danger')
			}
		} else {
			result = result
			.replace(/PLACEHOLDER_SUCCESS/g, 'btn-success')
			.replace(/PLACEHOLDER_DANGER/g, 'btn-danger')
		}

		messages_reject = '';
		$.each(list_messages_reject, function(index, message) {
			messages_reject += '<a class="dropdown-item" data-id_assignment="'+id+'" href="#">'+message+'</a>'
		});
		result = result.replace(/PLACEHOLDER_MESSAGES_REJECT/g, messages_reject);

		return result
	}

	function decode(input) {
	    const txt = document.createElement("textarea");
	    txt.innerHTML = input;
	    return txt.value;
	}
</script>
<div class="container-fluid" id="page_view">
	<div class="row">
		<div class="col-7">
	<form method="post">
		{% csrf_token %}
		<div class="row mt-2">
			<div class="col">
				<button type="button" data-task="submit_annotations" class="btn btn-primary">Submit</button>
				<button type="button" data-task="button_mturk_approve_selected" class="btn btn-success">Approve selected</button>
				<div class="btn-group">
	            	<button type="button" name="task" data-task="button_mturk_reject_selected" class="btn btn-danger">Reject selected</button>
					<button type="button" class="btn btn-danger dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"></button>
					<div class="dropdown-menu dropdown_reject_assignment_selected">
					{% for message in queryset_messages_reject.all %}
						<a class="dropdown-item" href="#">{{ message.message }}</a>
					{% endfor %}
					</div>
				</div>
			</div>
			<div class="col">
				<div class="input-group mb-3">
					<div class="input-group-prepend">
						<label class="input-group-text" for="input_message_reject_default">Default reject message</label>
						<button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"></button>
						<div class="dropdown-menu" id="dropdown_message_reject_default">
						{% for message in queryset_messages_reject.all %}
							<a class="dropdown-item" href="#">{{ message.message }}</a>
						{% endfor %}
						</div>
					</div>
					<input type="text" id="input_message_reject_default" class="form-control" required>
					<div class="invalid-feedback">
				        Please provide a valid default reject message!
			      </div>
				</div>
			</div>
		</div>
		<hr>
		<div class="row" id="wrapper_hits">
		{% for hit in queryset_hits %}
			<script>
				question = JSON.parse('{{hit.parameters|safe}}');
				
				hit_wrapper = $(decode(`{{ hit.fk_batch.fk_template.fk_template_hit.template }}`));
				$('#wrapper_hits').append(hit_wrapper)

				var wrapper_assignments = $($('[data-inject_assignments]')[$('[data-inject_assignments]').length - 1]);

				{% for assignment in hit.list_assignments %}

				answer_raw = JSON.parse('{{assignment.answer|safe}}');
				answer = JSON.parse('{{assignment.answer_normalized|safe}}');

				assignment_wrapper = $(decode(`{{ hit.fk_batch.fk_template.fk_template_assignment.template }}`));
				wrapper_assignments.append(assignment_wrapper)
				
				var wrapper_input_forms = $($('[data-inject_input_forms]')[$('[data-inject_input_forms]').length - 1]);
				wrapper_input_forms.html(create_inputs({{ assignment.id }}{% if assignment.is_approved %}, 'approved'{% elif assignment.is_rejected %}, 'rejected'{% endif %}))
				{% endfor %}
			</script>
		{% endfor %}
		</div>
		<hr>
		<div class="row">
			<div class="col">
				<button type="button" data-task="submit_annotations" class="btn btn-primary">Submit</button>
				<button type="button" name="task" data-task="button_mturk_approve_selected" class="btn btn-success">Approve selected</button>
				<div class="btn-group">
	            	<button type="button" name="task" data-task="button_mturk_reject_selected" class="btn btn-danger">Reject selected</button>
					<button type="button" class="btn btn-danger dropdown-toggle dropdown-toggle-split" data-toggle="dropdown"></button>
					<div class="dropdown-menu dropdown_reject_assignment_selected">
					{% for message in queryset_messages_reject.all %}
						<a class="dropdown-item" href="#">{{ message.message }}</a>
					{% endfor %}
					</div>
				</div>
			</div>
		</div>
	</form>
		</div>
		<div class="col">
			<pre></pre>
		</div>
	</div>
</div>
{% endblock %}	

{% block javascript %}
	<script src="{% static 'mturk_manager/js/view.js' %}"></script>
{% endblock %}	